{% extends 'base.html' %}
{% load static %}

{% block title %}Template-Editor - {{ deal.title }} - DealShare{% endblock %}

{% block extra_css %}
<style>
    .template-editor {
        display: flex;
        height: calc(100vh - 200px);
        background: #f8f9fa;
    }
    
    .sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    .canvas {
        flex: 1;
        background: white;
        margin: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow-y: auto;
    }
    
    .element-library {
        padding: 1rem;
    }
    
    .element-category {
        margin-bottom: 1.5rem;
    }
    
    .element-category h6 {
        color: #6c757d;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .element {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: grab;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .element:hover {
        background: #e9ecef;
        border-color: #007bff;
    }
    
    .element.dragging {
        opacity: 0.5;
    }
    
    .element i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
        color: #6c757d;
    }
    
    .drop-zone {
        min-height: 400px;
        padding: 2rem;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        margin: 1rem;
        background: #f8f9fa;
    }
    
    .drop-zone.drag-over {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .drop-zone.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 1.1rem;
    }
    
    .canvas-element {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
        cursor: move;
    }
    
    .canvas-element:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .element-controls {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: none;
    }
    
    .canvas-element:hover .element-controls {
        display: block;
    }
    
    .element-controls button {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        margin-left: 0.25rem;
    }
    
    .toolbar {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .element-settings {
        background: white;
        border-left: 1px solid #dee2e6;
        width: 300px;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .settings-panel {
        display: none;
    }
    
    .settings-panel.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="template-editor">
    <!-- Sidebar mit Element-Bibliothek -->
    <div class="sidebar">
        <div class="toolbar">
            <h5 class="mb-0">
                <i class="bi bi-palette me-2"></i>Elemente
            </h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="saveTemplate()">
                <i class="bi bi-save me-1"></i>Speichern
            </button>
        </div>
        
        <div class="element-library">
            {% for category_id, category_name in categories.items %}
            <div class="element-category">
                <h6>{{ category_name }}</h6>
                {% for element in elements %}
                    {% if element.category == category_id %}
                    <div class="element" draggable="true" data-element-id="{{ element.id }}" data-element-name="{{ element.name }}">
                        <i class="{{ element.icon }}"></i>
                        <span>{{ element.name }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas">
        <div class="toolbar">
            <h5 class="mb-0">{{ deal.title }} - Template Editor</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="previewTemplate()">
                    <i class="bi bi-eye me-1"></i>Vorschau
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="saveTemplate()">
                    <i class="bi bi-check me-1"></i>Speichern
                </button>
            </div>
        </div>
        
        <div class="drop-zone" id="main-content">
            <div class="empty-message">
                <i class="bi bi-arrow-down display-4 text-muted"></i>
                <p class="mt-3">Ziehen Sie Elemente hierher, um Ihr Template zu erstellen</p>
            </div>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="element-settings" id="settings-panel">
        <h6>Element-Einstellungen</h6>
        <div id="element-settings-content">
            <p class="text-muted">Wählen Sie ein Element aus, um die Einstellungen zu bearbeiten.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentLayout = [];
let selectedElement = null;

// Drag & Drop Funktionalität
document.addEventListener('DOMContentLoaded', function() {
    const elements = document.querySelectorAll('.element');
    const dropZone = document.getElementById('main-content');
    
    // Drag Events für Elemente
    elements.forEach(element => {
        element.addEventListener('dragstart', handleDragStart);
        element.addEventListener('dragend', handleDragEnd);
    });
    
    // Drop Zone Events
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragenter', handleDragEnter);
    dropZone.addEventListener('dragleave', handleDragLeave);
    
    // Initialisiere Layout
    initializeLayout();
});

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', e.target.dataset.elementId);
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDragEnter(e) {
    e.preventDefault();
    e.target.closest('.drop-zone').classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.closest('.drop-zone').classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    const dropZone = e.target.closest('.drop-zone');
    dropZone.classList.remove('drag-over');
    
    const elementId = e.dataTransfer.getData('text/plain');
    const elementName = e.target.closest('.element')?.dataset.elementName || 'Element';
    
    addElementToCanvas(elementId, elementName);
}

function addElementToCanvas(elementId, elementName) {
    const dropZone = document.getElementById('main-content');
    
    // Entferne Empty Message
    const emptyMessage = dropZone.querySelector('.empty-message');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // Erstelle neues Element
    const element = createCanvasElement(elementId, elementName);
    dropZone.appendChild(element);
    
    // Füge zu Layout hinzu
    currentLayout.push({
        id: elementId,
        name: elementName,
        content: '',
        settings: getDefaultSettings(elementId)
    });
    
    // Aktualisiere Layout
    updateLayout();
}

function createCanvasElement(elementId, elementName) {
    const element = document.createElement('div');
    element.className = 'canvas-element';
    element.dataset.elementId = elementId;
    
    element.innerHTML = `
        <div class="element-controls">
            <button class="btn btn-sm btn-outline-primary" onclick="editElement(this)">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="removeElement(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="element-content">
            <h6>${elementName}</h6>
            <p class="text-muted">Klicken Sie zum Bearbeiten</p>
        </div>
    `;
    
    // Click Event für Bearbeitung
    element.addEventListener('click', function() {
        selectElement(this);
    });
    
    return element;
}

function selectElement(element) {
    // Entferne vorherige Auswahl
    document.querySelectorAll('.canvas-element').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Wähle neues Element
    element.classList.add('selected');
    selectedElement = element;
    
    // Zeige Settings
    showElementSettings(element.dataset.elementId);
}

function showElementSettings(elementId) {
    const settingsPanel = document.getElementById('element-settings-content');
    
    let settingsHtml = '';
    
    switch(elementId) {
        case 'heading':
            settingsHtml = `
                <div class="mb-3">
                    <label class="form-label">Text</label>
                    <input type="text" class="form-control" id="heading-text" placeholder="Überschrift eingeben">
                </div>
                <div class="mb-3">
                    <label class="form-label">Größe</label>
                    <select class="form-select" id="heading-level">
                        <option value="h1">H1 (Groß)</option>
                        <option value="h2">H2 (Mittel)</option>
                        <option value="h3">H3 (Klein)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ausrichtung</label>
                    <select class="form-select" id="heading-align">
                        <option value="left">Links</option>
                        <option value="center">Zentriert</option>
                        <option value="right">Rechts</option>
                    </select>
                </div>
            `;
            break;
            
        case 'text':
            settingsHtml = `
                <div class="mb-3">
                    <label class="form-label">Text</label>
                    <textarea class="form-control" id="text-content" rows="4" placeholder="Text eingeben"></textarea>
                </div>
            `;
            break;
            
        case 'button':
            settingsHtml = `
                <div class="mb-3">
                    <label class="form-label">Text</label>
                    <input type="text" class="form-control" id="button-text" placeholder="Button-Text">
                </div>
                <div class="mb-3">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-control" id="button-url" placeholder="https://...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Style</label>
                    <select class="form-select" id="button-style">
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                        <option value="success">Success</option>
                        <option value="danger">Danger</option>
                    </select>
                </div>
            `;
            break;
            
        default:
            settingsHtml = '<p class="text-muted">Keine Einstellungen verfügbar.</p>';
    }
    
    settingsPanel.innerHTML = settingsHtml;
    
    // Event Listeners für Settings
    addSettingsEventListeners(elementId);
}

function addSettingsEventListeners(elementId) {
    // Hier würden Event Listeners für die Settings hinzugefügt
    // Die Änderungen würden das Layout aktualisieren
}

function getDefaultSettings(elementId) {
    const defaults = {
        'heading': { level: 'h2', align: 'left' },
        'text': {},
        'button': { style: 'primary', url: '#' },
        'image': { alt: 'Bild' },
        'card': { description: '' }
    };
    
    return defaults[elementId] || {};
}

function removeElement(button) {
    const element = button.closest('.canvas-element');
    const elementId = element.dataset.elementId;
    
    // Entferne aus Layout
    currentLayout = currentLayout.filter(item => item.id !== elementId);
    
    // Entferne aus DOM
    element.remove();
    
    // Prüfe ob Canvas leer ist
    const dropZone = document.getElementById('main-content');
    if (dropZone.children.length === 0) {
        dropZone.innerHTML = `
            <div class="empty-message">
                <i class="bi bi-arrow-down display-4 text-muted"></i>
                <p class="mt-3">Ziehen Sie Elemente hierher, um Ihr Template zu erstellen</p>
            </div>
        `;
    }
    
    updateLayout();
}

function initializeLayout() {
    // Lade gespeichertes Layout
    const savedLayout = {{ current_layout|safe }};
    if (savedLayout && savedLayout.length > 0) {
        savedLayout.forEach(item => {
            addElementToCanvas(item.id, item.name);
        });
    }
}

function updateLayout() {
    // Aktualisiere currentLayout basierend auf DOM
    const elements = document.querySelectorAll('.canvas-element');
    currentLayout = Array.from(elements).map(element => {
        return {
            id: element.dataset.elementId,
            name: element.querySelector('h6').textContent,
            content: element.querySelector('.element-content p').textContent,
            settings: getDefaultSettings(element.dataset.elementId)
        };
    });
}

function saveTemplate() {
    updateLayout();
    
    fetch('{% url "deals:template_editor" deal.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            layout: currentLayout
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Template wurde erfolgreich gespeichert!', 'success');
        } else {
            showAlert('Fehler beim Speichern: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Fehler beim Speichern: ' + error, 'danger');
    });
}

function previewTemplate() {
    // Öffne Vorschau in neuem Tab
    window.open('{% url "deals:dealroom_detail" deal.id %}', '_blank');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
    
    // Auto-remove nach 3 Sekunden
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 