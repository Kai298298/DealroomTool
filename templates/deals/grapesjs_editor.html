{% extends 'base.html' %}
{% load static %}

{% block title %}GrapesJS Editor - {{ deal.title }}{% endblock %}

{% block extra_css %}
<style>
    /* GrapesJS Editor Styles */
    .grapesjs-container {
        height: 100vh;
        width: 100%;
        position: relative;
    }
    
    .editor-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }
    
    .editor-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .editor-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .btn-preview {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }
    
               .btn-back {
               background: #6c757d;
               color: white;
               border: none;
               padding: 0.5rem 1rem;
               border-radius: 5px;
               cursor: pointer;
               text-decoration: none;
           }
           
           .btn-content-library {
               background: #17a2b8;
               color: white;
               border: none;
               padding: 0.5rem 1rem;
               border-radius: 5px;
               cursor: pointer;
           }
           
           .btn-quick-add {
               background: #28a745;
               color: white;
               border: none;
               padding: 0.5rem 1rem;
               border-radius: 5px;
               cursor: pointer;
           }
    
    /* GrapesJS Custom Styles */
    .gjs-cv-canvas {
        top: 60px !important;
    }
    
    .gjs-pn-panel {
        top: 60px !important;
    }
    
    .gjs-pn-views-container {
        top: 60px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="grapesjs-container">
    <!-- Editor Header -->
    <div class="editor-header">
        <h1>üé® GrapesJS Editor - {{ deal.title }}</h1>
                   <div class="editor-actions">
               <button class="btn-save" onclick="saveContent()">
                   <i class="bi bi-save"></i> Speichern
               </button>
               <button class="btn-preview" onclick="previewContent()">
                   <i class="bi bi-eye"></i> Vorschau
               </button>
               <button class="btn-content-library" onclick="openContentLibrary()">
                   <i class="bi bi-collection"></i> Content-Bibliothek
               </button>
               <button class="btn-quick-add" onclick="openQuickAdd()">
                   <i class="bi bi-plus-circle"></i> Schnell hinzuf√ºgen
               </button>
               <a href="{% url 'deals:dealroom_detail' deal.pk %}" class="btn-back">
                   <i class="bi bi-arrow-left"></i> Zur√ºck
               </a>
           </div>
    </div>
    
    <!-- GrapesJS Editor Container -->
    <div id="gjs"></div>
</div>

<!-- GrapesJS CDN -->
<script src="https://unpkg.com/grapesjs@0.21.2/dist/grapes.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/grapesjs@0.21.2/dist/css/grapes.min.css">

<!-- Custom GrapesJS Configuration -->
<script>
// Initial HTML Content
const initialHTML = `{{ initial_html|escapejs }}`;

// GrapesJS Editor Initialization
const editor = grapesjs.init({
    container: '#gjs',
    height: '100vh',
    width: 'auto',
    storageManager: {
        type: 'remote',
        autosave: true,
        stepsBeforeSave: 1,
        urlStore: '{% url "deals:grapesjs_editor" deal.pk %}',
        urlLoad: '{% url "deals:grapesjs_editor" deal.pk %}',
        params: {
            csrf_token: '{{ csrf_token }}'
        },
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    },
    assetManager: {
        embedAsBase64: false,
        upload: '{% url "deals:grapesjs_upload" %}',
        uploadName: 'files',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    },
    panels: {
        defaults: [
            {
                id: 'basic-actions',
                el: '.panel__basic-actions',
                buttons: [
                    {
                        id: 'visibility',
                        active: true,
                        className: 'btn-toggle-borders',
                        label: '<u>B</u>',
                        command: 'sw-visibility',
                    },
                ],
            },
        ],
    },
    deviceManager: {
        devices: [
            {
                name: 'Desktop',
                width: '',
            },
            {
                name: 'Tablet',
                width: '768px',
                widthMedia: '992px',
            },
            {
                name: 'Mobile',
                width: '320px',
                widthMedia: '480px',
            },
        ],
    },
    plugins: [
        'gjs-preset-webpage',
        'gjs-plugin-export',
        'gjs-plugin-code-editor'
    ],
    pluginsOpts: {
        'gjs-preset-webpage': {
            modalImportTitle: 'Template importieren',
            modalImportLabel: 'HTML, CSS oder JSON',
            modalImportContent: '',
            textCleanCanvas: 'Sind Sie sicher, dass Sie den Canvas leeren m√∂chten?',
        }
    }
});

// Set initial content
editor.setComponents(initialHTML);

// Save function
function saveContent() {
    const html = editor.getHtml();
    const css = editor.getCss();
    
    fetch('{% url "deals:grapesjs_editor" deal.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            html: html,
            css: css
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Inhalt erfolgreich gespeichert!');
        } else {
            alert('Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern');
    });
}

// Preview function
function previewContent() {
    const html = editor.getHtml();
    const css = editor.getCss();
    
    const previewWindow = window.open('', '_blank');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>{{ deal.title }} - Vorschau</title>
            <style>${css}</style>
        </head>
        <body>
            ${html}
        </body>
        </html>
    `);
    previewWindow.document.close();
}

// Content Library Integration
function openContentLibrary() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>üìö Content-Bibliothek</h2>
                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <h3>üìù Content-Bl√∂cke</h3>
                    <div id="content-blocks-list" style="max-height: 300px; overflow-y: auto;">
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addContentBlock('Call-to-Action Standard', 'Jetzt anfragen')">
                            <strong>Call-to-Action Standard</strong><br>
                            <small>Jetzt anfragen</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addContentBlock('Standard-Begr√º√üung', 'Willkommen in Ihrem pers√∂nlichen Dealroom! Wir freuen uns, Ihnen eine ma√ügeschneiderte L√∂sung anzubieten.')">
                            <strong>Standard-Begr√º√üung</strong><br>
                            <small>Willkommen in Ihrem pers√∂nlichen Dealroom!</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addContentBlock('Software-Produktbeschreibung', 'Eine umfassende Software-L√∂sung f√ºr Ihr Unternehmen mit modernster Technologie und benutzerfreundlicher Oberfl√§che.')">
                            <strong>Software-Produktbeschreibung</strong><br>
                            <small>Eine umfassende Software-L√∂sung...</small>
                        </div>
                    </div>
                </div>
                <div>
                    <h3>üñºÔ∏è Verf√ºgbare Medien</h3>
                    <div id="media-list" style="max-height: 300px; overflow-y: auto;">
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addMediaPlaceholder('Logo')">
                            <strong>Logo</strong><br>
                            <small>Unternehmenslogo</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addMediaPlaceholder('Hero-Bild')">
                            <strong>Hero-Bild</strong><br>
                            <small>Hauptbild f√ºr Landingpage</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer;" onclick="addMediaPlaceholder('Produktbild')">
                            <strong>Produktbild</strong><br>
                            <small>Produktabbildung</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    modal.className = 'modal';
    document.body.appendChild(modal);
}

function addContentBlock(title, content) {
    editor.addComponent(`
        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #667eea;">
            <h3 style="margin-bottom: 0.5rem; color: #333;">${title}</h3>
            <p style="margin: 0; line-height: 1.5; color: #666;">${content}</p>
        </div>
    `);
    document.querySelector('.modal').remove();
}

function addMediaPlaceholder(title) {
    editor.addComponent(`
        <div style="text-align: center; padding: 2rem; background: #f8f9fa; border: 2px dashed #ddd; border-radius: 8px; margin: 1rem 0;">
            <div style="width: 100px; height: 100px; background: #e9ecef; border-radius: 8px; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: #999;">
                <i style="font-size: 2rem;">üñºÔ∏è</i>
            </div>
            <h4 style="margin-bottom: 0.5rem; color: #333;">${title}</h4>
            <p style="margin: 0; color: #666; font-size: 0.9rem;">Klicken Sie hier, um ein Bild hochzuladen</p>
        </div>
    `);
    document.querySelector('.modal').remove();
}

// Quick Add Function
function openQuickAdd() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>‚ö° Schnell hinzuf√ºgen</h2>
                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                <button onclick="addHeroSection()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>üéØ Hero-Sektion</h4>
                    <small>Gro√üe √úberschrift mit Call-to-Action</small>
                </button>
                
                <button onclick="addInfoCard()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>üìã Info-Karte</h4>
                    <small>Produktinformationen in Karten</small>
                </button>
                
                <button onclick="addContactForm()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>üìû Kontaktformular</h4>
                    <small>Formular f√ºr Kundenkontakt</small>
                </button>
                
                <button onclick="addTestimonial()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>üí¨ Testimonial</h4>
                    <small>Kundenbewertung</small>
                </button>
                
                <button onclick="addPricingTable()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>üí∞ Preistabelle</h4>
                    <small>Preise und Features</small>
                </button>
                
                <button onclick="addFAQ()" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: center;">
                    <h4>‚ùì FAQ</h4>
                    <small>H√§ufige Fragen</small>
                </button>
            </div>
        </div>
    `;
    
    modal.className = 'modal';
    document.body.appendChild(modal);
}

function addHeroSection() {
    editor.addComponent(`
        <section style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 80px 20px; text-align: center;">
            <div style="max-width: 800px; margin: 0 auto;">
                <h1 style="font-size: 3rem; margin-bottom: 1rem;">Ihr Dealroom Titel</h1>
                <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">Professionelle Pr√§sentation Ihrer L√∂sung</p>
                <button style="background: white; color: #667eea; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">Jetzt anfragen</button>
            </div>
        </section>
    `);
    document.querySelector('.modal').remove();
}

function addInfoCard() {
    editor.addComponent(`
        <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 2rem 0;">
            <h3 style="color: #333; margin-bottom: 1rem;">Produkt√ºbersicht</h3>
            <p style="line-height: 1.6; color: #666;">Beschreiben Sie hier Ihre L√∂sung und die wichtigsten Features.</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 0.5rem;">Feature 1</h4>
                    <p style="margin: 0; font-size: 0.9rem;">Beschreibung</p>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 0.5rem;">Feature 2</h4>
                    <p style="margin: 0; font-size: 0.9rem;">Beschreibung</p>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 0.5rem;">Feature 3</h4>
                    <p style="margin: 0; font-size: 0.9rem;">Beschreibung</p>
                </div>
            </div>
        </div>
    `);
    document.querySelector('.modal').remove();
}

function addContactForm() {
    editor.addComponent(`
        <div style="background: #f8f9fa; padding: 3rem 2rem; border-radius: 12px; margin: 2rem 0;">
            <div style="max-width: 600px; margin: 0 auto;">
                <h3 style="text-align: center; margin-bottom: 2rem;">Kontaktieren Sie uns</h3>
                <form style="display: grid; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" placeholder="Vorname" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="text" placeholder="Nachname" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <input type="email" placeholder="E-Mail" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    <textarea placeholder="Ihre Nachricht" rows="4" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    <button type="submit" style="background: #667eea; color: white; border: none; padding: 1rem; border-radius: 6px; cursor: pointer;">Nachricht senden</button>
                </form>
            </div>
        </div>
    `);
    document.querySelector('.modal').remove();
}

function addTestimonial() {
    editor.addComponent(`
        <div style="background: white; padding: 3rem 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 2rem 0;">
            <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                <h3 style="margin-bottom: 2rem;">Was unsere Kunden sagen</h3>
                <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="font-style: italic; font-size: 1.1rem; margin-bottom: 1rem;">"Ausgezeichnete L√∂sung! Hat unsere Erwartungen √ºbertroffen."</p>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">JD</div>
                        <div>
                            <strong>Max Mustermann</strong><br>
                            <small style="color: #666;">Gesch√§ftsf√ºhrer, Muster GmbH</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    document.querySelector('.modal').remove();
}

function addPricingTable() {
    editor.addComponent(`
        <div style="background: #f8f9fa; padding: 3rem 2rem; border-radius: 12px; margin: 2rem 0;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <h3 style="text-align: center; margin-bottom: 2rem;">Unsere Preise</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">Starter</h4>
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">‚Ç¨99<span style="font-size: 1rem;">/Monat</span></div>
                        <ul style="list-style: none; padding: 0; margin-bottom: 2rem;">
                            <li style="padding: 0.5rem 0;">‚úì Feature 1</li>
                            <li style="padding: 0.5rem 0;">‚úì Feature 2</li>
                            <li style="padding: 0.5rem 0;">‚úì Feature 3</li>
                        </ul>
                        <button style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Jetzt w√§hlen</button>
                    </div>
                    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">Professional</h4>
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">‚Ç¨199<span style="font-size: 1rem;">/Monat</span></div>
                        <ul style="list-style: none; padding: 0; margin-bottom: 2rem;">
                            <li style="padding: 0.5rem 0;">‚úì Alle Starter Features</li>
                            <li style="padding: 0.5rem 0;">‚úì Premium Support</li>
                            <li style="padding: 0.5rem 0;">‚úì Erweiterte Funktionen</li>
                        </ul>
                        <button style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Jetzt w√§hlen</button>
                    </div>
                </div>
            </div>
        </div>
    `);
    document.querySelector('.modal').remove();
}

function addFAQ() {
    editor.addComponent(`
        <div style="background: white; padding: 3rem 2rem; border-radius: 12px; margin: 2rem 0;">
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="text-align: center; margin-bottom: 2rem;">H√§ufige Fragen</h3>
                <div style="display: grid; gap: 1rem;">
                    <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <button style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; text-align: left; cursor: pointer; font-weight: bold;">Wie funktioniert das System?</button>
                        <div style="padding: 1rem; border-top: 1px solid #ddd;">
                            <p>Hier steht die Antwort auf die h√§ufig gestellte Frage.</p>
                        </div>
                    </div>
                    <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <button style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; text-align: left; cursor: pointer; font-weight: bold;">Was kostet die L√∂sung?</button>
                        <div style="padding: 1rem; border-top: 1px solid #ddd;">
                            <p>Unsere Preise sind transparent und fair. Kontaktieren Sie uns f√ºr ein individuelles Angebot.</p>
                        </div>
                    </div>
                    <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <button style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; text-align: left; cursor: pointer; font-weight: bold;">Gibt es Support?</button>
                        <div style="padding: 1rem; border-top: 1px solid #ddd;">
                            <p>Ja, wir bieten umfassenden Support f√ºr alle unsere Kunden.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    document.querySelector('.modal').remove();
}

// Auto-save every 30 seconds
setInterval(saveContent, 30000);
</script>
{% endblock %} 