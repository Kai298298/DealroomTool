{% extends 'base.html' %}
{% load static %}

{% block title %}Landingpage Builder - {{ deal.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Top-Navigation */
    .builder-nav {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .builder-nav .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .builder-nav .nav-brand {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        text-decoration: none;
    }
    
    .builder-nav .nav-tabs {
        display: flex;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        list-style: none;
    }
    
    .builder-nav .nav-tab {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .builder-nav .nav-tab:hover,
    .builder-nav .nav-tab.active {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.4);
        transform: translateY(-1px);
    }
    
    /* Builder Layout */
    .builder-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        gap: 2rem;
        min-height: calc(100vh - 80px);
    }
    
    /* Sidebar */
    .builder-sidebar {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        height: fit-content;
        position: sticky;
        top: 100px;
    }
    
    .builder-sidebar h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.2rem;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
    }
    
    /* Content Library */
    .content-library {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .content-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .content-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .content-item h4 {
        margin: 0 0 0.25rem 0;
        font-size: 0.9rem;
        color: #333;
    }
    
    .content-item p {
        margin: 0;
        font-size: 0.8rem;
        color: #666;
    }
    
    /* Main Content Area */
    .builder-main {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .builder-main h2 {
        margin: 0 0 1.5rem 0;
        color: #333;
        font-size: 1.8rem;
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    /* Preview Area */
    .preview-area {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        height: fit-content;
        position: sticky;
        top: 100px;
    }
    
    .preview-area h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.2rem;
    }
    
    .preview-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        min-height: 200px;
        border: 2px dashed #dee2e6;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .builder-container {
            grid-template-columns: 250px 1fr;
        }
        .preview-area {
            display: none;
        }
    }
    
    @media (max-width: 768px) {
        .builder-container {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        .builder-nav .nav-tabs {
            flex-wrap: wrap;
        }
        .builder-nav .nav-tab {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Top Navigation -->
<nav class="builder-nav">
    <div class="nav-container">
        <a href="{% url 'deals:dealroom_detail' deal.id %}" class="nav-brand">
            üé® {{ deal.title }} - Landingpage Builder
        </a>
        <ul class="nav-tabs">
            <li><a href="#content" class="nav-tab {% if active_tab == 'content' %}active{% endif %}" data-tab="content">üìù Content</a></li>
            <li><a href="#media" class="nav-tab {% if active_tab == 'media' %}active{% endif %}" data-tab="media">üñºÔ∏è Medien</a></li>
            <li><a href="#layout" class="nav-tab {% if active_tab == 'layout' %}active{% endif %}" data-tab="layout">üé® Layout</a></li>
            <li><a href="#settings" class="nav-tab {% if active_tab == 'settings' %}active{% endif %}" data-tab="settings">‚öôÔ∏è Einstellungen</a></li>
            <li><a href="{% url 'deals:landingpage' deal.id %}" class="nav-tab" target="_blank">üëÅÔ∏è Vorschau</a></li>
            <li><a href="{% url 'deals:content_library' %}" class="nav-tab">üìö Bibliothek</a></li>
        </ul>
    </div>
</nav>

<!-- Builder Container -->
<div class="builder-container">
    <!-- Left Sidebar - Content Library -->
    <div class="builder-sidebar">
        <h3>üìö Content-Bibliothek</h3>
        
        <!-- Welcome Messages -->
        <div class="content-library">
            <h4>üëã Begr√º√üungen</h4>
            {% for block in content_blocks.welcome %}
            <div class="content-item" onclick="applyContentBlock({{ block.id }}, 'welcome')">
                <h4>{{ block.title }}</h4>
                <p>{{ block.description|default:block.content|truncatechars:50 }}</p>
            </div>
            {% empty %}
            <p style="color: #666; font-size: 0.9rem;">Keine Begr√º√üungen verf√ºgbar</p>
            {% endfor %}
        </div>
        
        <!-- Product Descriptions -->
        <div class="content-library">
            <h4>üì¶ Produktbeschreibungen</h4>
            {% for block in content_blocks.product_description %}
            <div class="content-item" onclick="applyContentBlock({{ block.id }}, 'product_description')">
                <h4>{{ block.title }}</h4>
                <p>{{ block.description|default:block.content|truncatechars:50 }}</p>
            </div>
            {% empty %}
            <p style="color: #666; font-size: 0.9rem;">Keine Produktbeschreibungen verf√ºgbar</p>
            {% endfor %}
        </div>
        
        <!-- Call-to-Actions -->
        <div class="content-library">
            <h4>üéØ Call-to-Actions</h4>
            {% for block in content_blocks.cta_text %}
            <div class="content-item" onclick="applyContentBlock({{ block.id }}, 'cta_text')">
                <h4>{{ block.title }}</h4>
                <p>{{ block.description|default:block.content|truncatechars:50 }}</p>
            </div>
            {% empty %}
            <p style="color: #666; font-size: 0.9rem;">Keine Call-to-Actions verf√ºgbar</p>
            {% endfor %}
        </div>
        
        <!-- Media Library -->
        <h3 style="margin-top: 2rem;">üñºÔ∏è Medien-Bibliothek</h3>
        
        <!-- Images -->
        <div class="content-library">
            <h4>üñºÔ∏è Bilder</h4>
            {% for media in media_library.image %}
            <div class="content-item" onclick="applyMedia({{ media.id }}, 'hero_image')">
                <h4>{{ media.title }}</h4>
                <p>{{ media.description|default:media.media_type|truncatechars:50 }}</p>
            </div>
            {% empty %}
            <p style="color: #666; font-size: 0.9rem;">Keine Bilder verf√ºgbar</p>
            {% endfor %}
        </div>
        
        <!-- Logos -->
        <div class="content-library">
            <h4>üè¢ Logos</h4>
            {% for media in media_library.logo %}
            <div class="content-item" onclick="applyMedia({{ media.id }}, 'logo')">
                <h4>{{ media.title }}</h4>
                <p>{{ media.description|default:media.media_type|truncatechars:50 }}</p>
            </div>
            {% empty %}
            <p style="color: #666; font-size: 0.9rem;">Keine Logos verf√ºgbar</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="builder-main">
        <h2>üìù Content bearbeiten</h2>
        
        <form method="post" action="{% url 'deals:landingpage_builder' deal.id %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_content">
            
            <!-- Hero Section -->
            <div class="form-group">
                <label for="hero_title">üéØ Hero-Titel</label>
                <input type="text" id="hero_title" name="hero_title" class="form-control" 
                       value="{{ deal.hero_title|default:'' }}" placeholder="Haupttitel der Landingpage">
            </div>
            
            <div class="form-group">
                <label for="hero_subtitle">üìù Hero-Untertitel</label>
                <textarea id="hero_subtitle" name="hero_subtitle" class="form-control" 
                          placeholder="Untertitel oder Beschreibung">{{ deal.hero_subtitle|default:'' }}</textarea>
            </div>
            
            <!-- Welcome Message -->
            <div class="form-group">
                <label for="welcome_message">üëã Willkommensnachricht</label>
                <textarea id="welcome_message" name="welcome_message" class="form-control" 
                          placeholder="Pers√∂nliche Begr√º√üung f√ºr den Kunden">{{ deal.welcome_message|default:'' }}</textarea>
            </div>
            
            <!-- Product Description -->
            <div class="form-group">
                <label for="product_description">üì¶ Produktbeschreibung</label>
                <textarea id="product_description" name="product_description" class="form-control" 
                          placeholder="Detaillierte Beschreibung des Produkts oder der Dienstleistung">{{ deal.product_description|default:'' }}</textarea>
            </div>
            
            <!-- Call-to-Action -->
            <div class="form-group">
                <label for="call_to_action">üéØ Call-to-Action Text</label>
                <input type="text" id="call_to_action" name="call_to_action" class="form-control" 
                       value="{{ deal.call_to_action|default:'' }}" placeholder="z.B. 'Jetzt anfragen' oder 'Angebot annehmen'">
            </div>
            
            <!-- Save Button -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    üíæ Content speichern
                </button>
                <a href="{% url 'deals:landingpage' deal.id %}" class="btn btn-secondary" target="_blank">
                    üëÅÔ∏è Vorschau anzeigen
                </a>
            </div>
        </form>
    </div>
    
    <!-- Right Sidebar - Preview -->
    <div class="preview-area">
        <h3>üëÅÔ∏è Live-Vorschau</h3>
        <div class="preview-content">
            <h4>{{ deal.hero_title|default:"Hero-Titel" }}</h4>
            <p>{{ deal.hero_subtitle|default:"Hero-Untertitel wird hier angezeigt..." }}</p>
            <hr>
            <p>{{ deal.welcome_message|default:"Willkommensnachricht wird hier angezeigt..." }}</p>
            <hr>
            <p>{{ deal.product_description|default:"Produktbeschreibung wird hier angezeigt..." }}</p>
            <hr>
            <button class="btn btn-primary">{{ deal.call_to_action|default:"Call-to-Action" }}</button>
        </div>
        
        <div style="margin-top: 1rem;">
            <h4>üìä Aktuelle Einstellungen</h4>
            <ul style="font-size: 0.9rem; color: #666;">
                <li><strong>Theme:</strong> {{ deal.get_theme_type_display }}</li>
                <li><strong>Template:</strong> {{ deal.get_template_type_display }}</li>
                <li><strong>Status:</strong> {{ deal.get_status_display }}</li>
                <li><strong>URL-Typ:</strong> {{ deal.get_url_type_display }}</li>
            </ul>
        </div>
    </div>
</div>

<!-- Hidden Forms for AJAX -->
<form id="contentBlockForm" method="post" action="{% url 'deals:landingpage_builder' deal.id %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="apply_content_block">
    <input type="hidden" name="content_block_id" id="contentBlockId">
</form>

<form id="mediaForm" method="post" action="{% url 'deals:landingpage_builder' deal.id %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="apply_media">
    <input type="hidden" name="media_id" id="mediaId">
    <input type="hidden" name="media_role" id="mediaRole">
</form>

<form id="layoutForm" method="post" action="{% url 'deals:landingpage_builder' deal.id %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="apply_layout">
    <input type="hidden" name="layout_id" id="layoutId">
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Tab Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            if (this.getAttribute('href').startsWith('#')) {
                e.preventDefault();
                const tabName = this.getAttribute('href').substring(1);
                switchTab(tabName);
            }
        });
    });
    
    function switchTab(tabName) {
        // Remove active class from all tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked tab
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Here you would show/hide different content sections
        console.log('Switched to tab:', tabName);
    }
    
    // Content Block Application
    function applyContentBlock(blockId, contentType) {
        document.getElementById('contentBlockId').value = blockId;
        document.getElementById('contentBlockForm').submit();
    }
    
    // Media Application
    function applyMedia(mediaId, mediaRole) {
        document.getElementById('mediaId').value = mediaId;
        document.getElementById('mediaRole').value = mediaRole;
        document.getElementById('mediaForm').submit();
    }
    
    // Layout Application
    function applyLayout(layoutId) {
        document.getElementById('layoutId').value = layoutId;
        document.getElementById('layoutForm').submit();
    }
    
    // Auto-save functionality
    let autoSaveTimer;
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                // Auto-save after 2 seconds of inactivity
                console.log('Auto-saving...');
            }, 2000);
        });
    });
    
    // Real-time preview updates
    document.getElementById('hero_title').addEventListener('input', function() {
        document.querySelector('.preview-content h4').textContent = this.value || 'Hero-Titel';
    });
    
    document.getElementById('hero_subtitle').addEventListener('input', function() {
        document.querySelector('.preview-content p').textContent = this.value || 'Hero-Untertitel wird hier angezeigt...';
    });
    
    document.getElementById('welcome_message').addEventListener('input', function() {
        const welcomeElement = document.querySelectorAll('.preview-content p')[1];
        welcomeElement.textContent = this.value || 'Willkommensnachricht wird hier angezeigt...';
    });
    
    document.getElementById('product_description').addEventListener('input', function() {
        const productElement = document.querySelectorAll('.preview-content p')[2];
        productElement.textContent = this.value || 'Produktbeschreibung wird hier angezeigt...';
    });
    
    document.getElementById('call_to_action').addEventListener('input', function() {
        document.querySelector('.preview-content .btn').textContent = this.value || 'Call-to-Action';
    });
</script>
{% endblock %} 